#!/bin/sh


###############################################################################
# Return codes
###############################################################################
rc_ok=0
rc_missing_arg=1


###############################################################################
# Utility functions
###############################################################################

log() {
  for arg
    do echo "$arg" >&2
  done
}

require_var() {
  name="$1"
  value=$(eval "echo \"\$$name\"")
  [ -z "$value" ] && log "Missing environment variable: $1" && return "$rc_missing_arg"
  return "$rc_ok"
}

require_command() {
  $(type -t "$1" | grep -q "^.\+$1\$")
  rc="$?"
  [ "$rc" -ne 0 ] && log "Error: command '$1' is missing."
  return "$rc"
}

prepare_env() {
  require_var TVHEADEND_USER     || return "$?"
  require_var TVHEADEND_PASSWORD || return "$?"
  require_var TVHEADEND_HOST     || return "$?"

  TVHEADEND_HTTP_PORT="${TVHEADEND_HTTP_PORT:-9981}"
  TVHEADEND_HTTP_URL="${TVHEADEND_HTTP_URL:-http://$TVHEADEND_HOST:$TVHEADEND_HTTP_PORT}"
  TVHEADEND_HTTP_TIMEOUT="${TVHEADEND_HTTP_TIMEOUT:-15}"

  MQTT_TOPIC_PREFIX="${MQTT_TOPIC_PREFIX:-tvheadend}"

  curl_options=""
  curl_options="$curl_options --get"
  curl_options="$curl_options -s"
  curl_options="$curl_options --max-time $TVHEADEND_HTTP_TIMEOUT"
  curl_options="$curl_options --user $TVHEADEND_USER:$TVHEADEND_PASSWORD"
}

print_json() {
  require_command jq || return "$?"
  echo "$1" | jq
}

entries_to_text() {
  require_command jq || return "$?"
  echo "$1" | jq -r ".entries[] | (.start_real | strflocaltime(\"%Y-%m-%dT%H:%M:%SZ\")) + \" \" + .channelname + \" - \" + .disp_title + if (.disp_subtitle | length > 0) then \" (\" + .disp_subtitle + \")\" else \"\" end"
}


###############################################################################
# Request HTTP via cURL
###############################################################################

request() {
  curl $curl_options $*
  rc="$?"
  case "$rc" in
  0)
    return "$rc"
    ;;
  7)
    message="Failed to connect to host"
    ;;
  28)
    message="Timeout after $TVHEADEND_HTTP_TIMEOUT seconds"
    ;;
  *)
    message="cURL returned $rc"
    ;;
  esac
  log "Error: $message while trying to access $*" && return "$rc"
}


###############################################################################
# Request JSON from pre-defined Tvheadend API endpoints
###############################################################################

get_status() {
  subscriptions=$(get_subscriptions) || return "$?"
  require_command jq || return "$?"
  subscription_count=$(echo "$subscriptions" | jq -r ".totalCount")
  upcoming=$(get_upcoming 1) || return "$?"
  status=$(echo "$upcoming" | jq ".entries[0] | {next: [((.start_real-now) / 60)|floor, 0] | max, title: .disp_title, subtitle: .disp_subtitle, channel: .channelname, status: .sched_status, subscriptions: $subscription_count}")

  print_json "$status"
}

get_subscriptions() {
  subscriptions=$(request "$TVHEADEND_HTTP_URL/api/status/subscriptions") || return "$?"
  require_command jq || return "$?"
  subscription_titles=$(echo "$subscriptions" | jq -r ".entries[] | .title")

  log "Subscriptions:" "${subscription_titles:-none}"
  print_json "$subscriptions"
}

get_connections() {
  connections=$(request "$TVHEADEND_HTTP_URL/api/status/connections") || return "$?"
  require_command jq || return "$?"
  connection_peers=$(echo "$connections" | jq ".entries[] | .peer")

  log "Clients:" "$connection_peers"
  print_json "$connections"
}

get_upcoming() {
  limit="${1:-5}"
  curl_local_options=""
  curl_local_options="$curl_local_options --data sort=start_real"
  curl_local_options="$curl_local_options --data dir=ASC"
  curl_local_options="$curl_local_options --data limit=$limit"
  upcoming=$(request $curl_local_options "$TVHEADEND_HTTP_URL/api/dvr/entry/grid_upcoming") || return "$?"
  upcoming_text=$(entries_to_text "$upcoming")

  log "Upcoming:" "$upcoming_text"
  print_json "$upcoming"
}

get_finished() {
  limit="${1:-10}"
  curl_local_options=""
  curl_local_options="$curl_local_options --data sort=start_real"
  curl_local_options="$curl_local_options --data dir=DESC"
  curl_local_options="$curl_local_options --data limit=$limit"
  finished=$(request $curl_local_options "$TVHEADEND_HTTP_URL/api/dvr/entry/grid_finished") || return "$?"
  finished_text=$(entries_to_text "$finished")

  log "Finished:" "$finished_text"
  print_json "$finished"
}


###############################################################################
# Publish and subscribe via MQTT
###############################################################################

publish() {
  log "$(date '+%Y-%m-%d %H:%M:%S') publish $*"

  require_var MQTT_BROKER_HOSTNAME || return "$?"
  require_command mosquitto_pub    || return "$?"
  info="$1"
  shift
  [ -z "$info" ] && log "Missing argument for requested Tvheadend info" && return "$rc_missing_arg"

  command="get_$info"
  if $(type -t "$command" | grep -q "^$command\( is a shell function\)\?\$"); then
    message=$("$command" $*)
  else
    message="Error: Unsupported Tvheadend info '$info'"
  fi

  log "Message:" "$message"
  mosquitto_pub -h "$MQTT_BROKER_HOSTNAME" -t "$MQTT_TOPIC_PREFIX/$info" -m "$message"
}

subscribe() {
  log "$(date '+%Y-%m-%d %H:%M:%S') subscribe"
  # '$info' must not be quoted so that arguments are handed over separately
  mosquitto_sub -h "$MQTT_BROKER_HOSTNAME" -t "$MQTT_TOPIC_PREFIX/request" | while read info; do publish $info; done
}


###############################################################################
# Prepare environment
###############################################################################

prepare_env || exit "$?"


###############################################################################
# Run arguments
###############################################################################

$*
